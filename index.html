<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Agente Virtual de Biolog√≠a</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .header .logo-container img {
            height: 50px;
            width: auto;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .config-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .config-panel h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card .label {
            font-size: 1.1em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .table-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        .table-card h3 {
            margin-bottom: 20px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:hover {
            background: #f5f5f5;
        }

        .message-preview {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.connected {
            background: #4caf50;
            color: white;
        }

        .status.disconnected {
            background: #f44336;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .success {
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters select, .filters input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .refresh-btn {
            background: #4caf50;
            margin-left: auto;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .pagination .btn {
            padding: 8px 20px;
            font-size: 14px;
        }

        .pagination .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        #page-info {
            color: #333;
        }

        /* üì± RESPONSIVE DESIGN - Mobile & Tablet */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.6em;
            }

            .header .logo-container img {
                height: 40px;
            }

            .config-panel, .stat-card, .chart-card, .table-card {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card .number {
                font-size: 2em;
            }

            .stat-card .label {
                font-size: 0.85em;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .filters {
                flex-direction: column;
            }

            .filters select, .filters input, .filters button {
                width: 100%;
            }

            .btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 15px;
            }

            .pagination {
                flex-direction: column;
                gap: 10px;
            }

            .pagination button {
                width: 100%;
            }

            table {
                font-size: 13px;
            }

            th, td {
                padding: 8px 4px;
            }

            .message-preview {
                max-width: 150px;
            }

            .table-card {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card .number {
                font-size: 1.8em;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 6px 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAAAyCAYAAAAZUZThAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAABDCSURBVHgB7Z0HdFTVFobP9E4SSCUJNYTeewchCKIgIEWKIE1AARWw0FEQQUCqgKAiIE1ARUGK9C4dQpcaQg+BkJ5M3/vOSWYgQJJJmZlkEvZ663/rnLP33fe+e+/dZ05ERESERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERE" alt="UXDigital Logo" style="height: 50px;">
                <h1>Reporte Agente Virtual de Biolog√≠a</h1>
            </div>
            <p>An√°lisis de conversaciones en tiempo real</p>
            <div id="connection-status"></div>
        </div>

        <div class="config-panel">
            <h3>üîß Configuraci√≥n de Supabase</h3>
            <div class="input-group">
                <div>
                    <label for="supabase-url">Supabase URL:</label>
                    <input type="text" id="supabase-url" placeholder="https://tu-proyecto.supabase.co" value="https://xycaebocoeuwbhygjhjn.supabase.co">
                </div>
                <div>
                    <label for="supabase-key">Supabase Anon Key:</label>
                    <input type="password" id="supabase-key" placeholder="Tu clave anon p√∫blica">
                </div>
            </div>
            <button class="btn" onclick="connectSupabase()">üîå Conectar y Cargar Datos</button>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div class="filters">
                <select id="period-filter" onchange="loadData()">
                    <option value="all">Todos los registros</option>
                    <option value="today">Hoy</option>
                    <option value="week">√öltima semana</option>
                    <option value="month">√öltimo mes</option>
                </select>
                <input type="date" id="date-from" onchange="loadData()">
                <input type="date" id="date-to" onchange="loadData()">
                <button class="btn refresh-btn" onclick="loadData()">üîÑ Actualizar</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="total-conversations">0</div>
                    <div class="label">Total Conversaciones</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="total-sessions">0</div>
                    <div class="label">Sesiones √önicas</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="avg-rating">-</div>
                    <div class="label">Rating Promedio</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="total-ratings">0</div>
                    <div class="label">Calificaciones</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üìà Conversaciones por D√≠a</h3>
                    <canvas id="dailyChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>‚≠ê Distribuci√≥n de Calificaciones</h3>
                    <canvas id="ratingsChart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üïê Conversaciones por Hora</h3>
                    <canvas id="hourlyChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>üìä Calificaciones por D√≠a</h3>
                    <canvas id="ratingsTimeChart"></canvas>
                </div>
            </div>

            <div class="chart-card" style="margin-bottom: 30px;">
                <h3>üìä Top 10 Sesiones m√°s Activas</h3>
                <canvas id="sessionsChart"></canvas>
            </div>

            <div class="table-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">üí¨ √öltimas Conversaciones</h3>
                    <button class="btn" onclick="downloadCSV()" style="padding: 8px 20px; font-size: 14px;">
                        üì• Descargar Todas (CSV)
                    </button>
                </div>
                <table id="conversations-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Fecha y Hora (Chile)</th>
                            <th>Mensaje</th>
                            <th>Rating</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                    </tbody>
                </table>
                <div class="pagination">
                    <button class="btn" onclick="previousPage()" id="prev-btn">‚¨ÖÔ∏è Anterior</button>
                    <span id="page-info" style="margin: 0 20px; font-weight: 600;">P√°gina 1</span>
                    <button class="btn" onclick="nextPage()" id="next-btn">Siguiente ‚û°Ô∏è</button>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            ‚è≥ Cargando datos...
        </div>

        <div id="message" style="display: none;"></div>
    </div>

    <script>
        let supabaseUrl;
        let supabaseKey;
        let allData = [];
        let charts = {};
        let currentPage = 1;
        const rowsPerPage = 25;

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = `<span class="status ${isError ? 'disconnected' : 'connected'}">${message}</span>`;
        }

        function showMessage(message, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = isError ? 'error' : 'success';
            messageDiv.innerHTML = message;
            messageDiv.style.display = 'block';
            
            if (!isError) {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        async function fetchSupabase(endpoint, options = {}) {
            const url = `${supabaseUrl}/rest/v1/${endpoint}`;
            
            const headers = {
                'apikey': supabaseKey,
                'Authorization': `Bearer ${supabaseKey}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            };

            const response = await fetch(url, {
                ...options,
                headers: { ...headers, ...options.headers }
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`HTTP ${response.status}: ${error}`);
            }

            return response.json();
        }

        async function connectSupabase() {
            supabaseUrl = document.getElementById('supabase-url').value.trim();
            supabaseKey = document.getElementById('supabase-key').value.trim();

            if (!supabaseUrl || !supabaseKey) {
                showMessage('Por favor ingresa la URL y la clave de Supabase', true);
                return;
            }

            // Asegurar que la URL tenga el protocolo correcto
            if (!supabaseUrl.startsWith('http://') && !supabaseUrl.startsWith('https://')) {
                supabaseUrl = 'https://' + supabaseUrl;
                document.getElementById('supabase-url').value = supabaseUrl;
            }

            try {
                showStatus('Conectando...', false);
                document.getElementById('message').style.display = 'none';
                
                console.log('Probando conexi√≥n a:', supabaseUrl);
                
                // Test connection
                const data = await fetchSupabase('agente_biologia_ava?select=id&limit=1');
                
                console.log('Conexi√≥n exitosa!');
                showStatus('‚úÖ Conectado', false);
                showMessage('‚úÖ Conexi√≥n exitosa a Supabase', false);
                document.getElementById('dashboard-content').style.display = 'block';
                await loadData();
                
            } catch (error) {
                console.error('Error completo:', error);
                showStatus('‚ùå Error de conexi√≥n', true);
                
                showMessage(`
                    <strong>Error al conectar:</strong><br>
                    ${error.message}<br><br>
                    <strong>Verifica:</strong><br>
                    1. La URL es correcta: ${supabaseUrl}<br>
                    2. La clave anon es correcta<br>
                    3. Row Level Security est√° configurado con pol√≠tica de lectura p√∫blica<br>
                    4. La tabla 'agente_biologia_ava' existe
                `, true);
            }
        }

        async function loadData() {
            if (!supabaseUrl || !supabaseKey) return;

            document.getElementById('loading').style.display = 'block';

            try {
                let query = 'agente_biologia_ava?select=id,session_id,message,user_email,rating,created_at,created_at_chile:created_at&order=created_at.desc';

                // Apply filters
                const period = document.getElementById('period-filter').value;
                const dateFrom = document.getElementById('date-from').value;
                const dateTo = document.getElementById('date-to').value;

                if (period === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    query += `&created_at=gte.${today}`;
                } else if (period === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    query += `&created_at=gte.${weekAgo.toISOString()}`;
                } else if (period === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    query += `&created_at=gte.${monthAgo.toISOString()}`;
                }

                if (dateFrom) {
                    query += `&created_at=gte.${dateFrom}T00:00:00`;
                }
                if (dateTo) {
                    const endDate = new Date(dateTo);
                    endDate.setDate(endDate.getDate() + 1);
                    query += `&created_at=lt.${endDate.toISOString()}`;
                }

                const data = await fetchSupabase(query);
                
                // Convertir created_at de UTC a Chile manualmente
                data.forEach(item => {
                    if (item.created_at) {
                        // Crear fecha UTC y aplicar offset de Chile (UTC-3 en verano, UTC-4 en invierno)
                        const utcDate = new Date(item.created_at);
                        // PostgreSQL devuelve UTC, restar 3 horas para Chile (verano)
                        // La zona horaria America/Santiago maneja autom√°ticamente el horario de verano
                        const chileOffset = -3 * 60; // UTC-3 en minutos
                        const localOffset = utcDate.getTimezoneOffset(); // Offset del navegador
                        const totalOffset = chileOffset - localOffset;
                        
                        const chileDate = new Date(utcDate.getTime() + totalOffset * 60000);
                        item.created_at_local = chileDate;
                    }
                });
                
                allData = data;
                updateDashboard(data);
                console.log('Datos cargados:', data.length, 'registros');
                
            } catch (error) {
                showMessage('Error al cargar datos: ' + error.message, true);
                console.error('Error:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateDashboard(data) {
            // Reset pagination
            currentPage = 1;
            
            // Update stats
            document.getElementById('total-conversations').textContent = data.length;
            
            const uniqueSessions = new Set(data.map(d => d.session_id)).size;
            document.getElementById('total-sessions').textContent = uniqueSessions;

            // Calculate ratings
            const ratingsData = data.filter(d => d.rating !== null && d.rating !== undefined);
            const totalRatings = ratingsData.length;
            document.getElementById('total-ratings').textContent = totalRatings;
            
            if (totalRatings > 0) {
                const avgRating = (ratingsData.reduce((sum, d) => sum + d.rating, 0) / totalRatings).toFixed(1);
                document.getElementById('avg-rating').textContent = avgRating + ' ‚≠ê';
            } else {
                document.getElementById('avg-rating').textContent = '-';
            }

            // Update charts
            updateDailyChart(data);
            updateHourlyChart(data);
            updateRatingsChart(data);
            updateRatingsTimeChart(data);
            updateSessionsChart(data);
            updateTable(data);
        }

        function updateDailyChart(data) {
            const dailyData = {};
            data.forEach(item => {
                const date = item.created_at.split('T')[0];
                dailyData[date] = (dailyData[date] || 0) + 1;
            });

            const sortedDates = Object.keys(dailyData).sort();
            const counts = sortedDates.map(date => dailyData[date]);

            if (charts.daily) charts.daily.destroy();

            const ctx = document.getElementById('dailyChart').getContext('2d');
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Conversaciones',
                        data: counts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateHourlyChart(data) {
            const hourlyData = new Array(24).fill(0);
            data.forEach(item => {
                const hour = new Date(item.created_at).getHours();
                hourlyData[hour]++;
            });

            if (charts.hourly) charts.hourly.destroy();

            const ctx = document.getElementById('hourlyChart').getContext('2d');
            charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Conversaciones',
                        data: hourlyData,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateSessionsChart(data) {
            const sessionCounts = {};
            data.forEach(item => {
                sessionCounts[item.session_id] = (sessionCounts[item.session_id] || 0) + 1;
            });

            const sortedSessions = Object.entries(sessionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (charts.sessions) {
                charts.sessions.destroy();
                charts.sessions = null;
            }

            const ctx = document.getElementById('sessionsChart').getContext('2d');
            charts.sessions = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedSessions.map(s => s[0].substring(0, 20) + '...'),
                    datasets: [{
                        label: 'Mensajes',
                        data: sortedSessions.map(s => s[1]),
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: '#764ba2',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateRatingsChart(data) {
            // Contar ratings del 1 al 5
            const ratingCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            data.forEach(item => {
                if (item.rating >= 1 && item.rating <= 5) {
                    ratingCounts[item.rating]++;
                }
            });

            if (charts.ratings) {
                charts.ratings.destroy();
                charts.ratings = null;
            }

            const ctx = document.getElementById('ratingsChart').getContext('2d');
            charts.ratings = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['‚≠ê 1', '‚≠ê‚≠ê 2', '‚≠ê‚≠ê‚≠ê 3', '‚≠ê‚≠ê‚≠ê‚≠ê 4', '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5'],
                    datasets: [{
                        label: 'Cantidad',
                        data: [ratingCounts[1], ratingCounts[2], ratingCounts[3], ratingCounts[4], ratingCounts[5]],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(234, 179, 8, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(16, 185, 129, 0.8)'
                        ],
                        borderColor: [
                            '#ef4444',
                            '#f97316',
                            '#eab308',
                            '#22c55e',
                            '#10b981'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateRatingsTimeChart(data) {
            // Agrupar ratings por d√≠a
            const dailyRatings = {};
            data.forEach(item => {
                if (item.rating >= 1 && item.rating <= 5) {
                    const date = item.created_at.split('T')[0];
                    if (!dailyRatings[date]) {
                        dailyRatings[date] = [];
                    }
                    dailyRatings[date].push(item.rating);
                }
            });

            const sortedDates = Object.keys(dailyRatings).sort();
            const avgRatings = sortedDates.map(date => {
                const ratings = dailyRatings[date];
                return (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1);
            });

            if (charts.ratingsTime) {
                charts.ratingsTime.destroy();
                charts.ratingsTime = null;
            }

            const ctx = document.getElementById('ratingsTimeChart').getContext('2d');
            charts.ratingsTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Rating Promedio',
                        data: avgRatings,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5" style="text-align: center; padding: 20px;">No hay conversaciones para mostrar</td>';
                document.getElementById('prev-btn').disabled = true;
                document.getElementById('next-btn').disabled = true;
                return;
            }

            // Calcular paginaci√≥n
            const totalPages = Math.ceil(data.length / rowsPerPage);
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = data.slice(startIndex, endIndex);

            // Actualizar informaci√≥n de p√°gina
            document.getElementById('page-info').textContent = `P√°gina ${currentPage} de ${totalPages} (${data.length} total)`;
            
            // Habilitar/deshabilitar botones
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;

            // Renderizar filas
            pageData.forEach(item => {
                const row = tbody.insertRow();
                
                let dateChile = 'N/A';
                try {
                    const utcDate = new Date(item.created_at);
                    // NOTA: La base de datos guarda en hora Chile (no en UTC)
                    // Por lo tanto NO necesitamos restar 3 horas
                    const chileDate = utcDate;
                    
                    // Formatear en formato legible
                    const day = String(chileDate.getUTCDate()).padStart(2, '0');
                    const month = String(chileDate.getUTCMonth() + 1).padStart(2, '0');
                    const year = chileDate.getUTCFullYear();
                    const hours = String(chileDate.getUTCHours()).padStart(2, '0');
                    const minutes = String(chileDate.getUTCMinutes()).padStart(2, '0');
                    const seconds = String(chileDate.getUTCSeconds()).padStart(2, '0');
                    
                    dateChile = `${day}-${month}-${year}, ${hours}:${minutes}:${seconds}`;
                    
                } catch (e) {
                    console.error('Error formateando fecha:', e);
                    dateChile = item.created_at;
                }

                let messagePreview = 'Sin mensaje';
                try {
                    if (item.message) {
                        const msg = typeof item.message === 'string' ? JSON.parse(item.message) : item.message;
                        messagePreview = msg.content || msg.text || JSON.stringify(msg).substring(0, 50);
                    }
                } catch (e) {
                    messagePreview = String(item.message || '').substring(0, 50);
                }

                const email = item.user_email || '-';
                const rating = item.rating ? '‚≠ê'.repeat(item.rating) + ` (${item.rating})` : '-';

                row.innerHTML = `
                    <td>${item.id || 'N/A'}</td>
                    <td>${email}</td>
                    <td>${dateChile}</td>
                    <td class="message-preview" title="${messagePreview}">${messagePreview}</td>
                    <td style="text-align: center;">${rating}</td>
                `;
            });
        }

        function nextPage() {
            const totalPages = Math.ceil(allData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateTable(allData);
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable(allData);
            }
        }

        function downloadCSV() {
            if (!allData || allData.length === 0) {
                showMessage('No hay datos para descargar', true);
                return;
            }

            // Crear CSV
            let csv = 'ID,Email,Session ID,Fecha y Hora (Chile),Mensaje,Rating\n';
            
            allData.forEach(item => {
                let dateChile = 'N/A';
                try {
                    const utcDate = new Date(item.created_at);
                    // La base de datos guarda en hora Chile (no UTC)
                    const chileDate = utcDate;
                    
                    const day = String(chileDate.getUTCDate()).padStart(2, '0');
                    const month = String(chileDate.getUTCMonth() + 1).padStart(2, '0');
                    const year = chileDate.getUTCFullYear();
                    const hours = String(chileDate.getUTCHours()).padStart(2, '0');
                    const minutes = String(chileDate.getUTCMinutes()).padStart(2, '0');
                    const seconds = String(chileDate.getUTCSeconds()).padStart(2, '0');
                    
                    dateChile = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
                } catch (e) {
                    console.error('Error formateando fecha:', e);
                    dateChile = item.created_at;
                }

                let messageText = '';
                try {
                    if (item.message) {
                        const msg = typeof item.message === 'string' ? JSON.parse(item.message) : item.message;
                        messageText = msg.content || msg.text || JSON.stringify(msg);
                        // Escapar comillas y saltos de l√≠nea para CSV
                        messageText = messageText.replace(/"/g, '""').replace(/\n/g, ' ');
                    }
                } catch (e) {
                    messageText = String(item.message || '');
                }

                const email = item.user_email || '';
                const rating = item.rating || '';

                csv += `${item.id},"${email}","${item.session_id}","${dateChile}","${messageText}",${rating}\n`;
            });

            // Crear archivo y descargarlo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const now = new Date();
            const filename = `conversaciones_chatbot_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage(`‚úÖ Descargado: ${filename} (${allData.length} registros)`, false);
        }

        // Set default date range
        const today = new Date();
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        document.getElementById('date-to').value = today.toISOString().split('T')[0];
        document.getElementById('date-from').value = weekAgo.toISOString().split('T')[0];
    </script>
</body>
</html>
